{%- comment -%}
  GSAP Marquee Section
  ------------------------------------------------------------------------------
  Auto-scrolling text using GSAP.
  Settings allow control over text, colors, speed, and gap.
{%- endcomment -%}

<style>
  .moving-promo-banner {
    width: 100%;
    overflow: hidden;
    display: flex;
    white-space: nowrap;
    /* Use Liquid settings for static styles */
    background-color: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    padding: 15px 0;
  }

  .moving-promo-banner__content {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    /* Pass the gap setting to CSS */
    padding-right: {{ section.settings.gap_width }}px;

    /* Typography settings */
    font-size: {{ section.settings.font_size }}px;
    font-weight: {{ section.settings.font_weight }};
    text-transform: uppercase;
  }

  /* Link styling if text is a link */
  .moving-promo-banner__content a {
    color: inherit;
    text-decoration: none;
  }
</style>

<!-- Load GSAP (Only loads if not already present) -->
<script>
  if (!window.gsap) {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js";
    script.defer = true;
    document.head.appendChild(script);
  }
</script>

<div
  class="moving-promo-banner js-marquee-container"
  data-speed="{{ section.settings.speed }}"
  data-pause="{{ section.settings.pause_on_hover }}"
  data-direction="{{ section.settings.direction }}">
  <div class="moving-promo-banner__content js-marquee-content">
    {%- if section.settings.link != blank -%}
      <a href="{{ section.settings.link }}">
        <span>{{ section.settings.text }}</span>
      </a>
    {%- else -%}
      <span>{{ section.settings.text }}</span>
    {%- endif -%}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  // Wait for GSAP to load if it was injected
  const initMarquee = () => {
    if (typeof gsap === 'undefined') {
      setTimeout(initMarquee, 100);
      return;
    }

    // Select all instances (in case you use this section multiple times)
    const containers = document.querySelectorAll(".js-marquee-container");

    containers.forEach((container) => {
      const content = container.querySelector(".js-marquee-content");
      
      if (!content) return;

      // 1. Check if already cloned (prevents duplication on theme editor reload)
      if (container.querySelectorAll('.js-marquee-content').length === 1) {
        const clonedContent = content.cloneNode(true);
        container.appendChild(clonedContent);
      }
      
      // Re-select contents after cloning
      const allContents = container.querySelectorAll(".js-marquee-content");

      // 2. Get Settings from Data Attributes
      const speedSetting = parseInt(container.getAttribute("data-speed")) || 100; // Pixels per second
      const pauseOnHover = container.getAttribute("data-pause") === "true";
      const direction = container.getAttribute("data-direction") || "left";

      // 3. Calculate Duration
      const contentWidth = content.offsetWidth;
      // Duration = Distance / Speed
      const duration = contentWidth / speedSetting;

      // 4. Determine Direction
      // If Left: Move from 0 to -100%
      // If Right: Move from -100% to 0
      const xPercentValue = direction === 'left' ? -100 : 0;
      const startValue = direction === 'left' ? 0 : -100;

      // Reset positions just in case
      gsap.set(allContents, { xPercent: startValue });

      // 5. Create Animation
      const marqueeAnim = gsap.to(allContents, {
        xPercent: direction === 'left' ? -100 : 0,
        repeat: -1,
        duration: duration,
        ease: "linear"
      }).totalProgress(0.5);

      // 6. Hover Event
      if (pauseOnHover) {
        container.addEventListener("mouseenter", () => marqueeAnim.pause());
        container.addEventListener("mouseleave", () => marqueeAnim.play());
      }
    });
  };

  initMarquee();
  
  // Reload on Shopify Theme Editor changes
  document.addEventListener("shopify:section:load", initMarquee);
  });
</script>

{% schema %}
  {
    "name": "GSAP Marquee Banner",
    "settings": [
      {
        "type": "header",
        "content": "Content"
      },
      {
        "type": "text",
        "id": "text",
        "label": "Announcement Text",
        "default": "FLAT 10% OFF ON YOUR 1ST ORDER. USE CODE: GETACTIVE"
      },
      {
        "type": "url",
        "id": "link",
        "label": "Link (Optional)"
      },
      {
        "type": "header",
        "content": "Appearance"
      },
      {
        "type": "color",
        "id": "bg_color",
        "label": "Background Color",
        "default": "#000000"
      },
      {
        "type": "color",
        "id": "text_color",
        "label": "Text Color",
        "default": "#ffffff"
      },
      {
        "type": "range",
        "id": "font_size",
        "min": 10,
        "max": 40,
        "step": 1,
        "unit": "px",
        "label": "Font Size",
        "default": 14
      },
      {
        "type": "select",
        "id": "font_weight",
        "label": "Font Weight",
        "options": [
          {
            "value": "normal",
            "label": "Normal"
          },
          {
            "value": "bold",
            "label": "Bold"
          }
        ],
        "default": "bold"
      },
      {
        "type": "range",
        "id": "padding_y",
        "min": 5,
        "max": 50,
        "step": 1,
        "unit": "px",
        "label": "Vertical Padding",
        "default": 12
      },
      {
        "type": "range",
        "id": "gap_width",
        "min": 0,
        "max": 200,
        "step": 5,
        "unit": "px",
        "label": "Gap between text",
        "default": 50
      },
      {
        "type": "header",
        "content": "Animation Settings"
      },
      {
        "type": "range",
        "id": "speed",
        "min": 20,
        "max": 500,
        "step": 10,
        "label": "Speed (Pixels per second)",
        "default": 100,
        "info": "Higher number = Faster"
      },
      {
        "type": "select",
        "id": "direction",
        "label": "Direction",
        "options": [
          {
            "value": "left",
            "label": "Right to Left"
          },
          {
            "value": "right",
            "label": "Left to Right"
          }
        ],
        "default": "left"
      },
      {
        "type": "checkbox",
        "id": "pause_on_hover",
        "label": "Pause on hover",
        "default": true
      }
    ],
    "presets": [
      {
        "name": "GSAP Marquee Banner"
      }
    ]
  }
{% endschema %}